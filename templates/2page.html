<!doctype html>
<html lang="ko">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>


    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        * {
            /*font-family: 'Jua', sans-serif;*/
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        li {
            list-style: none;
        }

        a {
            text-decoration: none;
        }

        .header {
            width: 750px;
            background-color: #fdf3d0;
            margin: auto;
        }

        .header p {
            font-size: 40px;
            text-align: center;
            font-family: 'Jua', sans-serif;
            color: #544315;
        }

        /*지도api위치*/
        .content {
            width: 500px;
            margin: auto;
        }

        .map {
            border: 2px solid black;
            width: 500px;
            height: 400px;
            margin: 30px auto 20px auto;
        }

        .map img {
            margin: 30px 65px;
        }

        /*일몰,일출 시간*/
        .time-menu {
            display: flex;
            width: 100%;
            position: relative;
            /*background-color: aquamarine;*/
            align-items: center;
            height: 30px;
        }

        .time {
            position: absolute;
            font-size: 25px;
            display: block;
        }

        .time span {
            background-color: #fdf3d0;
            font-weight: normal;
        }

        #sunrise {
            background-color: white;
        }

        #sunset {
            background-color: white;
        }

        .time strong {
            margin-left: 10px;
        }

        /*정렬순서*/
        .sub-menu {
            position: absolute;
            width: 100px;
            right: 0px;
            top: 0px;
        }

        /*명소 목록*/
        .review {
            width: 500px;
            height: 200px;
            margin: 30px auto 10px auto;
            display: flex;
        }

        .review-in {
            border: 1px solid black;
            width: 240px;
            height: 210px;
        }

        #review-fir {
            margin-right: 20px;
        }

        #review-sec {
            margin-left: 20px;
        }

        .review-in-image {
            width: 230px;
            height: 150px;
        }

        .review-in img {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        .review-in p {
            font-size: 15px;
            margin-top: 7px;
            margin-left: 5px;
        }
    </style>

    <title>해보러갈래?</title>
    <!--<script src="/static/show_place.js"></script>-->
</head>
<body>
<div class="wrap">
    <div class="header">
        <p>{{ data }}</p>
    </div>
    <div class="content">
        <div class="map" id="map">

        </div>
        <div class="time-menu">
            <div class="time">
                <span>일출:</span> <span id="sunrise"></span>&emsp;&emsp;&emsp;&emsp;&emsp;<span>일몰:</span><span
                    id="sunset"></span>
            </div>
            <div class="sub-menu">
                <select class="form-control">
                    <option>인기순</option>
                    <option>추천순</option>
                    <option>최신순</option>
                    <option>별점순</option>
                </select>
            </div>
        </div>
    </div>
    <div class="review">
        <div class="review-in" id="review-fir">
            <div class="review-in-image">
                <img src="https://cdn.pixabay.com/photo/2014/12/16/22/25/woman-570883__340.jpg" alt="review">
                <p>장소명 : 명소 <br> 주소 : 이 세상 어딘가</p>
            </div>
        </div>
        <div class="review-in" id="review-sec">
            <div class="review-in-image">
                <img src="https://cdn.pixabay.com/photo/2016/09/01/19/43/sunset-1637376_960_720.jpg" alt="review">
                <p>장소명 : 명소 <br> 주소 : 이 세상 어딘가</p>
            </div>
        </div>

    </div>
</div>


</div>


<script src="https://d3js.org/d3.v5.js"></script>
<script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=535068688f1a8bca1c21a9445ede0a89"></script>
<script>
    var array = {{places | tojson}};

    var markerPosition = new kakao.maps.LatLng(array[0]['latitude'], array[0]['longtitude'])
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: markerPosition, // 지도의 중심좌표
            level: 11 // 지도의 확대 레벨
        };

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
    var positions = new Array();


    for (let i = 0; i < array.length; i++) {
        let now_name = array[i]['name'];
        let now_long = array[i]['longtitude'];
        let now_lati = array[i]['latitude'];
        var now_dict = {
            title: now_name,
            latlng: new kakao.maps.LatLng(now_lati, now_long)
        }

        positions.push(now_dict)


    }
    // console.log(positions)


    // 마커 이미지의 이미지 주소입니다
    var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

    for (let i = 0; i < positions.length; i++) {

        var imageSize = new kakao.maps.Size(24, 35);    // 마커 이미지의 이미지 크기 입니다
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);  // 마커 이미지를 생성합니다

        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
            map: map,  // 마커를 표시할 지도
            position: positions[i].latlng, // 마커를 표시할 위치
            title: positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
            image: markerImage, // 마커 이미지
            clickable: true,

        });


        kakao.maps.event.addListener(marker, 'mouseover', function () {
            show_time(marker)
        });//클릭하면 일출일몰시간보임
        kakao.maps.event.addListener(marker, 'mouseout', function () {
            delete_time()
        });

    }

    //마커눌렀을때 일출일몰시간 api 뜨는 함수
    function show_time(marker) {


        var long = marker.getPosition().getLng();
        var lati = marker.getPosition().getLat();

        console.log(long, lati)

        function getCurrentDate() {
            var date = new Date();
            var year = date.getFullYear().toString();

            var month = date.getMonth() + 1;
            month = month < 10 ? '0' + month.toString() : month.toString();

            var day = date.getDate();
            day = day < 10 ? '0' + day.toString() : day.toString();

            return year + month + day;
        }

        var date = getCurrentDate();

        //alert(date)
        show(long, lati, date);


        function show(longitude, latitude, date) {

            console.log(longitude)
            console.log(latitude)


            $.ajax({
                type: "GET",
                url: "/time?&long="+longitude+"&lati="+latitude+"&date="+date,
                dataType:'xml',
                success: function (response) {

                    xmlParsing(response);


                },
                error: function (xhr, status, msg) { // 통신 실패시 호출해야하는 함수
                    console.log('상태값 : ' + status + ' Http에러메시지 : ' + msg);
                },

            });
        }

        function xmlParsing(data) {
            var riseList = ``; //일출
            var setList = ``; //일몰
            $(data).find('items').each(function (index, item) {

                riseList += `${$(this).find('sunrise').text()}`;
                setList += `${$(this).find('sunset').text()}`;

                $('#sunrise').append(riseList);
                $('#sunset').append(setList);


            });
        }


    }

    function delete_time() {

        $('#sunrise').empty();
        $('#sunset').empty();

    }


</script>


</body>
</html>